---
name: joplin

networks:
  frontend:
    external: true
  internal:
    external: false

volumes:
  postgres.etc:
  postgres.var:
  postgres.backup:

services:
  joplin:
    image: docker.io/11notes/joplin:3
    user: "${DOCKER_USER_ID:-2021}:${DOCKER_GROUP_ID:-2021}"
    # prevents write access to the image itself
    read_only: true
    # prevents any process within the container to gain more privileges
    security_opt:
      - "no-new-privileges=true"
    depends_on:
      db:
        condition: "service_healthy"
        restart: true
    restart: unless-stopped
    environment:
      TZ: "${TZ:-UTC}"
      APP_PORT: '22300'
      APP_BASE_URL: "${APP_BASE_URL:-https://joplin.jakerob.pro}"
      DB_CLIENT: pg
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_DATABASE: "${POSTGRES_DATABASE:-joplin}"
      POSTGRES_USER: "${POSTGRES_USER:-joplin}"
      POSTGRES_PORT: "${POSTGRES_PORT:-5432}"
      POSTGRES_HOST: db
    networks:
      - frontend
      - internal
    volumes:
      - "./data/joplin/etc:/joplin/etc"
      - "./data/joplin/var:/joplin/var"
    tmpfs:
      # required for read-only
      - "/tmp:uid=${DOCKER_USER_ID:-2021},gid=${DOCKER_GROUP_ID:-2021}"
    labels:
      traefik.enable: true
      traefik.external: true
      traefik.http.services.joplin-prod-1.loadbalancer.server.port: 22300
      traefik.http.routers.joplin-prod-1-http.entrypoints: web
      traefik.http.routers.joplin-prod-1-http.rule: Host(`joplin.jakerob.pro`)
      traefik.http.routers.joplin-prod-1-https.entrypoints: websecure
      traefik.http.routers.joplin-prod-1-https.rule: Host(`joplin.jakerob.pro`)
      traefik.http.routers.joplin-prod-1-https.tls: true
      traefik.http.routers.joplin-prod-1-https.tls.certresolver: production
  db:
    image: "11notes/postgres:18"
    user: "2021:2021"
    # prevents write access to the image itself
    read_only: true
    # prevents any process within the container to gain more privileges
    security_opt:
      - "no-new-privileges=true"
    restart: unless-stopped
    environment:
      TZ: "${TZ:-UTC}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      # make a full and compressed database backup each day at 03:00
      POSTGRES_BACKUP_SCHEDULE: "0 3 * * *"
      # only keep the last five backups
      POSTGRES_BACKUP_RETENTION: 5
    volumes:
      - "postgres.etc:/postgres/etc"
      - "postgres.var:/postgres/var"
      - "postgres.backup:/postgres/backup"
    tmpfs:
      # needed for read-only
      - "/postgres/run:uid=2021,gid=2021"
      - "/postgres/log:uid=2021,gid=2021"
    networks:
      - internal
