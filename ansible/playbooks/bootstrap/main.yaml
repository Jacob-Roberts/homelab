---
- name: Bootstrap new homelab node
  hosts: "bootstrap"
  become: true
  vars:
    bootstrap_admins:
      - name: jacobroberts
        ssh_key: "{{ lookup('file', '../../ssh_keys/jacobroberts.pub') }}"
    
  tasks:
    - name: Create admin users
      ansible.builtin.user:
        name: "{{ item.name }}"
        groups: sudo
        shell: /bin/bash
        state: present
        create_home: true
      loop: "{{ bootstrap_admins }}"

    - name: Add SSH keys for admin users
      ansible.posix.authorized_key:
        user: "{{ item.name }}"
        key: "{{ item.ssh_key }}"
        state: present
      loop: "{{ bootstrap_admins }}"

    - name: Create sudoers file for admin users
      ansible.builtin.file:
        path: /etc/sudoers.d/admins
        state: touch
        mode: "0440"

    - name: Allow admin users passwordless sudo
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/admins
        line: "{{ item.name }} ALL=(ALL) NOPASSWD:ALL"
        state: present
        regexp: "^{{ item.name }} ALL="
        validate: '/usr/sbin/visudo -cf %s'
      loop: "{{ bootstrap_admins }}"

    - name: Ensure SSH password authentication is disabled
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present
      notify: restart ssh

    - name: Disable password authentication for root
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        state: present
        regexp: "^#?PermitRootLogin"
        line: "PermitRootLogin prohibit-password"
      notify: restart ssh

  handlers:
    - name: restart ssh
      ansible.builtin.service:
        name: ssh
        state: restarted