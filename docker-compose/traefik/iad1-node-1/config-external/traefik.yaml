# yaml-language-server: $schema=https://json.schemastore.org/traefik-v3.json

# Needed for health check
ping:
  terminatingStatusCode: 204

tracing:
  otlp:
    grpc:
      endpoint: "alloy:4137"
      insecure: true

global:
  checkNewVersion: false
  sendAnonymousUsage: false

# -- (Optional) Change Log Level and Format here...
#     - loglevels [TRACE, DEBUG, INFO, WARN, ERROR, FATAL, and PANIC]
#     - format [common, json, logfmt]
log:
  level: "INFO"
  format: json
  maxSize: 100
  maxBackups: 3
  maxAge: 3
  compress: true
#  format: common
#  filePath: /var/log/traefik/traefik.log

# -- (Optional) Enable Accesslog and change Format here...
#     - format [common, json, logfmt]
accesslog: # We enable access logs as json
  bufferingSize: 100 # Add buffering for better performance
  fields:
    defaultMode: drop     # Start with dropping all fields
    headers:
      defaultMode: drop # Start with dropping all headers
      names:
        User-Agent: keep # Keep user agent for tracking
        X-Real-Ip: keep # Keep real IP for tracking
        X-Forwarded-For: keep # Keep forwarded IP for tracking
        X-Forwarded-Proto: keep # Keep forwarded protocol for tracking
        Content-Type: keep # Keep content type for tracking
        Authorization: redact  # Redact sensitive information
        Cookie: redact        # Redact sensitive information
    names:
      ClientAddr: keep # Keep client address for IP tracking
      ClientHost: keep  # Keep client host for IP tracking
      RequestMethod: keep # Keep request method for tracking
      RequestPath: keep # Keep request path for tracking
      RequestProtocol: keep # Keep request protocol for tracking
      DownstreamStatus: keep # Keep downstream status for tracking
      DownstreamContentSize: keep # Keep downstream content size for tracking
      Duration: keep # Keep request duration for tracking
      ServiceName: keep # Keep service name for tracking
      StartUTC: keep # Keep start time for tracking
      TLSVersion: keep # Keep TLS version for tracking
      TLSCipher: keep # Keep TLS cipher for tracking
      RetryAttempts: keep # Keep retry attempts for tracking
  filePath: /var/log/traefik/access.log
  filters:
    minDuration: 100ms # Increased to focus on slower requests
    retryAttempts: true
    statusCodes:
      - 200-299 # Success codes
      - 400-499 # Client errors
      - 500-599 # Server errors
  format: json

# -- (Optional) Enable API and Dashboard here, don't do in production
api:
  dashboard: true
  insecure: true # TODO: Expose the dashboard securely

# -- Change EntryPoints here...
entryPoints:
  web:
    address: :80
    http:
      encodedCharacters:
        allowEncodedBackSlash: false
        allowEncodedHash: false
        allowEncodedPercent: false
        allowEncodedNullCharacter: false
        allowEncodedQuestionMark: false
        allowEncodedSemicolon: false
        allowEncodedSlash: false
    # -- (Optional) Redirect all HTTP to HTTPS
    # http:
    #   redirections:
    #     entryPoint:
    #       to: websecure
    #       scheme: https
  websecure:
    address: :443
    http:
      middlewares:
        - crowdsec@file
        - geoblock@file
        - identify-node@file
      encodedCharacters:
        allowEncodedBackSlash: false
        allowEncodedHash: false
        allowEncodedPercent: false
        allowEncodedNullCharacter: false
        allowEncodedQuestionMark: false
        allowEncodedSemicolon: false
        allowEncodedSlash: false
  # -- (Optional) Add custom Entrypoint
  # custom:
  #   address: :8080

# -- Configure your CertificateResolver here...
certificatesResolvers:
  staging:
    acme:
      email: jroberts.g1ql8@simplelogin.com
      storage: /traefik/certs/acme.json
      caServer: "https://acme-staging-v02.api.letsencrypt.org/directory"
      httpChallenge:
        entryPoint: web
  production:
    acme:
      email: jroberts.g1ql8@simplelogin.com
      storage: /traefik/certs/acme.json
      caServer: "https://acme-v02.api.letsencrypt.org/directory"
      httpChallenge:
        entryPoint: web

# -- (Optional) Disable TLS Cert verification check
serversTransport:
  insecureSkipVerify: true

# -- (Optional) Overwrite Default Certificates
# tls:
#   stores:
#     default:
#       defaultCertificate:
#         certFile: /traefik/certs/cert.pem
#         keyFile: /traefik/certs/cert-key.pem
# -- (Optional) Disable TLS version 1.0 and 1.1
#   options:
#     default:
#       minVersion: VersionTLS12

providers:
  docker:
    # -- (Optional) Enable this, if you want to expose all containers automatically
    exposedByDefault: false
    constraints: "Label(`traefik.external`,`true`)"
    endpoint: "unix:///var/run/docker.sock"
    watch: true
    network: frontend
  file:
    directory: /traefik/conf/
    watch: false

experimental:
  plugins:
    crowdsec:
      moduleName: github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin
      version: v1.4.2
    geoblock:
      moduleName: github.com/PascalMinder/geoblock
      version: v0.3.3