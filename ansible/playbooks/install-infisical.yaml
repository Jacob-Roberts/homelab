---
- name: Install Infisical CLI
  hosts: all
  become: true

  vars:
    infisical_gpg_key_url: "https://artifacts-cli.infisical.com/infisical.gpg"
    infisical_repo_url: "https://artifacts-cli.infisical.com/deb"
    infisical_keyring_path: "/usr/share/keyrings/infisical-archive-keyring.gpg"

  tasks:
    - name: Install required system packages
      ansible.builtin.apt:
        pkg:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: true

    - name: Install Debian-specific packages
      ansible.builtin.apt:
        pkg:
          - debian-keyring
          - debian-archive-keyring
        state: present
      when: ansible_distribution == "Debian"

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /usr/share/keyrings
        state: directory
        mode: "0755"

    - name: Download Infisical GPG key
      ansible.builtin.get_url:
        url: "{{ infisical_gpg_key_url }}"
        dest: /tmp/infisical.gpg.asc
        mode: "0644"

    - name: Dearmor and install GPG key
      ansible.builtin.shell: |
        gpg --dearmor < /tmp/infisical.gpg.asc > {{ infisical_keyring_path }}
        chmod 644 {{ infisical_keyring_path }}
      args:
        creates: "{{ infisical_keyring_path }}"

    - name: Add Infisical apt repository
      ansible.builtin.apt_repository:
        filename: infisical
        repo: "deb [arch={{ ansible_architecture | replace('x86_64', 'amd64') | replace('aarch64', 'arm64') }} signed-by={{ infisical_keyring_path }}] {{ infisical_repo_url }} stable main"
        state: present
        update_cache: true

    - name: Install Infisical CLI
      ansible.builtin.apt:
        name: infisical
        state: present
        update_cache: true

    - name: Clean up temporary GPG key file
      ansible.builtin.file:
        path: /tmp/infisical.gpg.asc
        state: absent

    - name: Verify Infisical installation
      ansible.builtin.command: infisical --version
      register: infisical_version
      changed_when: false

    - name: Display Infisical version
      ansible.builtin.debug:
        msg: "Infisical CLI installed: {{ infisical_version.stdout }}"

