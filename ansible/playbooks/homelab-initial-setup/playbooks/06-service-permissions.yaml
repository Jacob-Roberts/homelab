---
# =============================================================================
# Service Directory Permissions
# =============================================================================
# Run: ansible-playbook playbooks/06-service-permissions.yaml
#
# This playbook:
# - Sets correct ownership and permissions on service directories
# - Ensures services can write to their config/data directories
#
# Note: Requires 04-git-repo.yaml and 05-service-users.yaml to have been run first
# =============================================================================

- name: Service Directory Permissions
  hosts: "{{ target_host | default('lhr1-node-1') }}"
  become: true

  vars_files:
    - ../vars/main.yaml

  tasks:
    - name: Traefik writable paths
      ansible.builtin.file:
        path: "{{ item }}"
        owner: traefik
        group: homelab-admins
        recurse: true
        mode: "u=rwX,g=rwX,o=rX,g+s"
      loop:
        - /srv/homelab/repo/docker-compose/traefik/lhr1-node-1/config/certs
        - /srv/homelab/repo/docker-compose/traefik/lhr1-node-1/config/plugins

    - name: Jellyfin writable paths
      ansible.builtin.file:
        path: "{{ item }}"
        owner: jellyfin
        group: homelab-admins
        recurse: true
        mode: "u=rwX,g=rwX,o=rX,g+s"
      loop:
        - /srv/homelab/repo/docker-compose/jellyfin/lhr1-node-1/config
        - /srv/homelab/repo/docker-compose/jellyfin/lhr1-node-1/cache

