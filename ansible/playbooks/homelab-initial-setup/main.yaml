---
- name: Setup Homelab git service folder
  hosts: lhr1-node-1
  become: true
  vars:
    homelab_system_user: homelab
    homelab_users:
      - jacobroberts
    homelab_admins_group: homelab-admins
    nfs_mounts:
      - path: /media/immich
        src: truenas.lhr1.jakerob.pro:/mnt/bulk-slow/encrypted/immich
        fstype: nfs
        state: mounted
      - path: /media/jellydata
        src: truenas.lhr1.jakerob.pro:/mnt/bulk-slow/encrypted/jellyfin
        fstype: nfs
        state: mounted
      - path: /media/roberts-data
        src: truenas.lhr1.jakerob.pro:/mnt/bulk-slow/encrypted/pbj-drive
        fstype: nfs
        state: mounted
    homelab_dir: /srv/homelab/repo
    homelab_home: /srv/homelab
    homelab_ssh_dir: /srv/homelab/.ssh
    homelab_ssh_key_path: /srv/homelab/.ssh/id_ed25519
    homelab_git_repo_url: "git@github.com:Jacob-Roberts/homelab.git"
    homelab_git_repo_https_url: https://github.com/Jacob-Roberts/homelab/

    github_host_key: |-
      # github.com:22 SSH-2.0-1e748d5
      github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA179cnfGWOWRVruj16z6XyvxvjJwbz0wQZ75XK5tKSb7FNyeIEs4TT4jk+S4dhPeAUC5y+bDYirYgM4GC7uEnztnZyaVWQ7B381AK4Qdrwt51ZqExKbQpTUNn+EjqoTwvqNj4kqx5QUCI0ThS/YkOxJCXmPUWZbhjpCg56i+2aB6CmK2JGhn57K5mj0MNdBXA4/WnwH6XoPWJzK5Nyu2zB3nAZp+S5hpQs+p1vN1/wsjk=
      # github.com:22 SSH-2.0-1e748d5
      github.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg=
      # github.com:22 SSH-2.0-1e748d5
      github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl
      # github.com:22 SSH-2.0-1e748d5
      # github.com:22 SSH-2.0-1e748d5

    service_users:
      - name: traefik
        uid: 2001
        gid: 2001
      - name: authentik
        uid: 2002
        gid: 2002
      - name: jellyfin
        uid: 2003
        gid: 2003
      - name: immich
        uid: 2004
        gid: 2004
      - name: paperless
        uid: 2005
        gid: 2005

    # Geerling security vars:
    security_ssh_password_authentication: "no"
    security_ssh_permit_root_login: "no"
    security_ssh_usedns: "no"
    security_ssh_permit_empty_password: "no"
    security_ssh_challenge_response_auth: "no"
    security_ssh_gss_api_authentication: "no"
    security_ssh_x11_forwarding: "no"
    security_ssh_allowed_users:
      - jacobroberts
    security_sshd_state: started
    security_ssh_restart_handler_state: restarted
    security_sudoers_passwordless:
      - jacobroberts
    security_sudoers_passworded: []
    security_autoupdate_enabled: true
    security_autoupdate_blacklist: []
    security_autoupdate_additional_origins: []
    # Luks will break on reboot
    security_autoupdate_reboot: false
    security_autoupdate_mail_to: "jroberts.glql8@simplelogin.com"
    security_autoupdate_mail_on_error: true
    security_fail2ban_enabled: true

    # Geerling docker vars:
    docker_edition: "ce"
    docker_users:
      - jacobroberts

  roles:
    - geerlingguy.security
    - geerlingguy.docker

  tasks:
    - name: Ensure homelab-admins group exists
      ansible.builtin.group:
        name: "{{ homelab_admins_group }}"
        state: present

    - name: Create homelab system user
      ansible.builtin.user:
        name: "{{ homelab_system_user }}"
        system: true
        home: "{{ homelab_home }}"
        groups:
          - "{{ homelab_admins_group }}"
        append: true
        shell: /usr/sbin/nologin
        create_home: true
        state: present

    - name: Ensure homelab home directory has correct group
      ansible.builtin.file:
        path: "{{ homelab_home }}"
        state: directory
        owner: "{{ homelab_system_user }}"
        group: "{{ homelab_admins_group }}"
        mode: "0770"

    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "{{ homelab_ssh_dir }}"
        state: directory
        owner: "{{ homelab_system_user }}"
        group: "{{ homelab_system_user }}"
        mode: "0700"

    - name: Generate SSH deploy key if missing
      ansible.builtin.openssh_keypair:
        path: "{{ homelab_ssh_key_path }}"
        type: ed25519
        owner: "{{ homelab_system_user }}"
        group: "{{ homelab_system_user }}"
        mode: "0600"
        comment: "homelab@infra"
      register: deploy_key

    - name: Show public key (for GitHub deploy key)
      ansible.builtin.debug:
        msg: "{{ deploy_key.public_key }}"
      when: deploy_key.changed

    - name: Upload deploy key to GitHub (manual step)
      ansible.builtin.pause:
        prompt: "Please add the following SSH public key as a deploy key with read access to the GitHub repo {{ homelab_git_repo_https_url  }}settings/keys:\n\n{{ deploy_key.public_key }}\n"
      when: deploy_key.changed

    - name: Pin GitHub host key
      ansible.builtin.known_hosts:
        path: "{{ homelab_ssh_dir }}/known_hosts"
        name: github.com
        key: "{{ item }}"
        state: present
      # homelab_system_user doesn't have a login shell, so we need these workarounds
      become_user: "{{ homelab_system_user }}"
      become_flags: "-H -S -n"
      vars:
        ansible_ssh_pipelining: true
      loop: "{{ github_host_key.split('\n') | select | reject('match', '^#') | list }}"

    - name: Disable SSH agent forwarding globally
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^AllowAgentForwarding"
        line: "AllowAgentForwarding no"
        state: present
      notify: restart ssh

    - name: Ensure homelab user cannot SSH interactively
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^DenyUsers.*{{ homelab_system_user }}.*"
        line: "DenyUsers {{ homelab_system_user }}"
        state: present
      notify: restart ssh

    - name: Create homelab human users
      ansible.builtin.user:
        name: "{{ item }}"
        shell: /bin/bash
        state: present
        groups:
          - "{{ homelab_admins_group }}"
        append: true
      loop: "{{ homelab_users }}"

    - name: Install git if not present
      ansible.builtin.package:
        name: git
        state: present

    - name: Clone homelab repo
      ansible.builtin.git:
        repo: "{{ homelab_git_repo_url }}"
        dest: "{{ homelab_dir }}"
        version: "{{ homelab_git_version | default('main') }}"
        force: yes
        update: yes
        key_file: "{{ homelab_ssh_key_path }}"
        ssh_opts: "-o UserKnownHostsFile={{ homelab_ssh_dir }}/known_hosts"
      # homelab_system_user doesn't have a login shell, so we need these workarounds
      become_user: "{{ homelab_system_user }}"
      become_flags: "-H -S -n"
      vars:
        ansible_ssh_pipelining: true

    - name: Set homelab repo ownership
      ansible.builtin.file:
        path: "{{ homelab_dir }}"
        state: directory
        owner: "{{ homelab_system_user }}"
        group: "{{ homelab_admins_group }}"
        recurse: yes
        mode: "2775" # 2 means that setgid â†’ new files inherit homelab-admins

    - name: Create service groups
      ansible.builtin.group:
        name: "{{ item.name }}"
        gid: "{{ item.gid }}"
        system: yes
      loop: "{{ service_users }}"

    # Create service system users
    - name: Create service users
      ansible.builtin.user:
        name: "{{ item.name }}"
        uid: "{{ item.uid }}"
        group: "{{ item.name }}"
        system: yes
        shell: /usr/sbin/nologin
      loop: "{{ service_users }}"

    - name: Traefik writable paths
      file:
        path: "{{ item }}"
        owner: traefik
        group: homelab-admins
        recurse: true
        mode: "u=rwX,g=rwX,o=rX,g+s"
      loop:
        - /srv/homelab/repo/docker-compose/traefik/lhr1-node-1/config/certs
        - /srv/homelab/repo/docker-compose/traefik/lhr1-node-1/config/plugins

    - name: Ensure NFS utilities exists
      ansible.builtin.apt:
        pkg:
          - nfs-common
        state: present

    - name: Mount NFS shares
      ansible.posix.mount:
        path: "{{ item.path }}"
        src: "{{ item.src }}"
        fstype: "{{ item.fstype }}"
        opts: rw,noatime,hard,_netdev,timeo=900,retrans=5
        state: "{{ item.state  }}"
      loop: "{{ nfs_mounts }}"

  handlers:
    - name: restart ssh
      ansible.builtin.service:
        name: ssh
        state: restarted
